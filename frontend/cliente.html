<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cliente - Reportes Ciudadanos</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
</head>
<body class="bg-gray-100 font-sans">
  <div class="max-w-4xl mx-auto p-6 bg-white shadow-xl mt-6 rounded-xl">
    <div class="flex justify-between items-center">
      <h1 class="text-2xl font-bold text-blue-700">ğŸ“ Sistema de Reportes Ciudadanos</h1>
      <button onclick="cerrarSesion()" class="text-red-600 font-bold">ğŸšª Cerrar sesiÃ³n</button>
    </div>

    <form id="form-reclamo" class="space-y-4 mt-6">
      <div>
        <label class="block">ğŸ“‚ Tipo de reclamo:</label>
        <select id="tipo" required class="w-full p-2 border rounded">
          <option value="">Seleccione</option>
          <option>Basura</option>
          <option>Alumbrado</option>
          <option>Bache</option>
          <option>Inseguridad</option>
          <option>Otro</option>
        </select>
      </div>
      <div>
        <label class="block">ğŸ“ DescripciÃ³n:</label>
        <textarea id="descripcion" required class="w-full p-2 border rounded"></textarea>
      </div>
      <div>
        <label class="block">ğŸ“ UbicaciÃ³n:</label>
        <input type="text" id="ubicacion" readonly class="w-full p-2 border rounded bg-gray-100" />
        <button type="button" onclick="detectarUbicacion()" class="mt-2 bg-blue-600 text-white px-4 py-1 rounded">ğŸ“¡ Detectar ubicaciÃ³n</button>
        <div id="mapa" class="h-64 mt-2 hidden"></div>
      </div>
      <div>
        <label class="block">ğŸ“§ Correo (opcional):</label>
        <input type="email" id="correo" class="w-full p-2 border rounded" />
      </div>
      <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded">ğŸ“¤ Enviar Reclamo</button>
    </form>

    <hr class="my-8" />

    <h2 class="text-xl font-semibold mb-4">ğŸ“„ Historial de mis Reclamos</h2>
    <div id="historial" class="mt-4 space-y-4"></div>
  </div>

  <script>
    let coords = null;

    function cerrarSesion() {
      window.location.href = "index.html";
    }

    async function detectarUbicacion() {
      if (!navigator.geolocation) {
        alert("La geolocalizaciÃ³n no es compatible");
        return;
      }

      navigator.geolocation.getCurrentPosition(async function(pos) {
        coords = {
          lat: pos.coords.latitude,
          lon: pos.coords.longitude
        };

        const url = `https://nominatim.openstreetmap.org/reverse?lat=${coords.lat}&lon=${coords.lon}&format=json`;
        const res = await fetch(url);
        const data = await res.json();

        document.getElementById("ubicacion").value = data.display_name;

        document.getElementById("mapa").classList.remove("hidden");
        const map = L.map('mapa').setView([coords.lat, coords.lon], 16);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        L.marker([coords.lat, coords.lon]).addTo(map)
          .bindPopup("Tu ubicaciÃ³n detectada").openPopup();
      }, function() {
        alert("No se pudo detectar la ubicaciÃ³n.");
      });
    }

    document.getElementById("form-reclamo").addEventListener("submit", async function(e) {
      e.preventDefault();

      const tipo = document.getElementById("tipo").value;
      const descripcion = document.getElementById("descripcion").value;
      const ubicacion = document.getElementById("ubicacion").value;
      const correo = document.getElementById("correo").value;

      localStorage.setItem("correo_cliente", correo); // Guardar correo en localStorage

      const res = await fetch("https://siresu1.onrender.com/reclamos", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ tipo, descripcion, ubicacion, correo })
      });

      if (res.ok) {
        alert("âœ… Reclamo enviado");
        this.reset();
        document.getElementById("mapa").classList.add("hidden");
        cargarHistorial();
      } else {
        alert("âŒ Error al enviar reclamo");
      }
    });

    async function cargarHistorial() {
      const correo = localStorage.getItem("correo_cliente");
      if (!correo || !correo.includes("@")) return;

      const res = await fetch("https://siresu1.onrender.com/api/reclamos");
      const reclamos = await res.json();
      const historial = document.getElementById("historial");
      historial.innerHTML = "";

      const filtrados = reclamos.filter(r => r.correo === correo);

      if (filtrados.length === 0) {
        historial.innerHTML = "<p>No hay reclamos registrados.</p>";
        return;
      }

      filtrados.forEach(r => {
        const div = document.createElement("div");
        div.className = "bg-white p-4 border rounded shadow";
        div.innerHTML = `
          <p><strong>ğŸ“‚ Tipo:</strong> ${r.tipo}</p>
          <p><strong>ğŸ“ DescripciÃ³n:</strong> ${r.descripcion}</p>
          <p><strong>ğŸ“ UbicaciÃ³n:</strong> ${r.ubicacion}</p>
          <p><strong>ğŸ“… Fecha de envÃ­o:</strong> ${new Date(r.fecha).toLocaleString()}</p>
          <p><strong>ğŸ“Œ Estado:</strong> ${r.estado}</p>
        `;
        historial.appendChild(div);
      });
    }

    window.onload = cargarHistorial;
  </script>
</body>
</html>
