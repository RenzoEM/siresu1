<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cliente - Reportes Ciudadanos</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>

  <link href="https://unpkg.com/aos@2.3.4/dist/aos.css" rel="stylesheet" />

  <style>
    .tab-hidden { display: none }
  </style>
</head>

<body class="bg-gray-100 font-sans">

<div class="max-w-4xl mx-auto p-6 bg-white shadow-xl mt-6 rounded-xl" data-aos="fade-up">

  <!-- CERRAR SESI√ìN -->
  <div class="fixed top-4 right-4">
    <button onclick="cerrarSesion()"
      class="bg-red-600 hover:bg-red-700 text-white font-semibold px-4 py-2 rounded shadow-md">
      Cerrar sesi√≥n
    </button>
  </div>

  <!-- TABS -->
  <div class="flex space-x-4 border-b mb-6 text-sm font-medium">
    <button id="tabForm" class="tab-btn border-b-2 border-blue-600 px-4 py-2"
      onclick="cambiarTab('formulario')">‚ûï Nuevo Reclamo</button>

    <button id="tabHist" class="tab-btn px-4 py-2"
      onclick="cambiarTab('historial')">üìÇ Historial</button>
  </div>

  <!-- FORMULARIO -->
  <div id="formulario">
    <form id="form-reclamo" class="space-y-6 mt-6">

      <div>
        <label class="block font-semibold mb-1">Tipo de reclamo:</label>
        <select id="tipo" required class="w-full p-2 border rounded">
          <option value="">Seleccione</option>
          <option>Basura</option>
          <option>Alumbrado</option>
          <option>Bache</option>
          <option>Inseguridad</option>
          <option>Otro</option>
        </select>
      </div>

      <div>
        <label class="block font-semibold mb-1">Descripci√≥n:</label>
        <textarea id="descripcion" required rows="4"
          class="w-full p-2 border rounded"></textarea>
      </div>

      <div>
        <label class="block font-semibold mb-1">Ubicaci√≥n:</label>
        <input id="ubicacion" readonly
          class="w-full p-2 border rounded bg-gray-100" />

        <button type="button" onclick="detectarUbicacion()"
          class="mt-2 bg-blue-600 text-white px-4 py-2 rounded">
          Detectar ubicaci√≥n
        </button>

        <div id="mapa" class="h-64 mt-4 rounded hidden"></div>
      </div>

      <button type="submit"
        class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded font-semibold">
        Enviar Reclamo
      </button>

    </form>
  </div>

  <!-- HISTORIAL -->
  <div id="historial" class="tab-hidden">
    <h2 class="text-xl font-semibold mb-4">Historial de mis Reclamos</h2>
    <div id="listaHistorial" class="space-y-4"></div>
  </div>

</div>

<script src="https://unpkg.com/aos@2.3.4/dist/aos.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {

  AOS.init({ duration:700, once:true });

  const API = "https://siresu1.onrender.com";
  const correo = localStorage.getItem("correo");

  if (!correo) {
    alert("Sesi√≥n no v√°lida. Inicia sesi√≥n nuevamente.");
    location.href = "index.html";
    return;
  }

  let coords = null;
  let mapaInstancia = null;

  /* ===== SESI√ìN ===== */
  window.cerrarSesion = function(){
    localStorage.clear();
    location.href = "index.html";
  }

  /* ===== TABS ===== */
  window.cambiarTab = function(tab){
    formulario.classList.add("tab-hidden");
    historial.classList.add("tab-hidden");

    document.getElementById(tab).classList.remove("tab-hidden");

    tabForm.classList.remove("border-blue-600");
    tabHist.classList.remove("border-blue-600");

    if(tab === "formulario") tabForm.classList.add("border-blue-600");
    else {
      tabHist.classList.add("border-blue-600");
      cargarHistorial();
    }
  }

  /* ===== UBICACI√ìN ===== */
  window.detectarUbicacion = function(){
    navigator.geolocation.getCurrentPosition(async pos=>{
      coords = { lat: pos.coords.latitude, lon: pos.coords.longitude };

      try{
        const res = await fetch(
          `https://nominatim.openstreetmap.org/reverse?lat=${coords.lat}&lon=${coords.lon}&format=json`
        );
        const data = await res.json();
        ubicacion.value = data.display_name || `${coords.lat}, ${coords.lon}`;
      }catch{}

      mapa.classList.remove("hidden");

      if(mapaInstancia) mapaInstancia.remove();
      mapaInstancia = L.map("mapa").setView([coords.lat,coords.lon],16);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(mapaInstancia);
      L.marker([coords.lat,coords.lon]).addTo(mapaInstancia);
    });
  }

  /* ===== ENVIAR RECLAMO ===== */
  form-reclamo.addEventListener("submit", async e=>{
    e.preventDefault();

    await fetch(`${API}/reclamos`,{
      method:"POST",
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        tipo: tipo.value,
        descripcion: descripcion.value,
        ubicacion: ubicacion.value,
        correo
      })
    });

    alert("Reclamo enviado correctamente");
    e.target.reset();
    mapa.classList.add("hidden");
  });

  /* ===== HISTORIAL ===== */
  async function cargarHistorial(){
    const res = await fetch(`${API}/api/reclamos`);
    const data = await res.json();

    const lista = data.filter(r => r.correo === correo);
    listaHistorial.innerHTML = "";

    if(lista.length === 0){
      listaHistorial.innerHTML =
        "<p class='italic text-gray-500'>No hay reclamos registrados.</p>";
      return;
    }

    lista.forEach(r=>{
      listaHistorial.innerHTML += `
        <div class="p-4 border rounded shadow bg-white">
          <p><b>Tipo:</b> ${r.tipo}</p>
          <p><b>Descripci√≥n:</b> ${r.descripcion}</p>
          <p><b>Ubicaci√≥n:</b> ${r.ubicacion}</p>
          <p><b>Estado:</b> ${r.estado}</p>
          <p><b>Fecha:</b> ${new Date(r.fecha).toLocaleString()}</p>
        </div>`;
    });
  }

});
</script>

</body>
</html>
