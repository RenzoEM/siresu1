<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cliente - Reportes Ciudadanos</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
</head>
<body class="bg-gray-100 font-sans">
  <div class="max-w-4xl mx-auto p-6 bg-white shadow-xl mt-6 rounded-xl">
    <div class="flex justify-between items-center">
      <h1 class="text-2xl font-bold text-blue-700">📍 Sistema de Reportes Ciudadanos</h1>
      <button onclick="cerrarSesion()" class="text-red-600 font-bold">🚪 Cerrar sesión</button>
    </div>

    <form id="form-reclamo" class="space-y-4 mt-6">
      <div>
        <label class="block">📂 Tipo de reclamo:</label>
        <select id="tipo" required class="w-full p-2 border rounded">
          <option value="">Seleccione</option>
          <option>Basura</option>
          <option>Alumbrado</option>
          <option>Bache</option>
          <option>Inseguridad</option>
          <option>Otro</option>
        </select>
      </div>
      <div>
        <label class="block">📝 Descripción:</label>
        <textarea id="descripcion" required class="w-full p-2 border rounded"></textarea>
      </div>
      <div>
        <label class="block">📍 Ubicación:</label>
        <input type="text" id="ubicacion" readonly class="w-full p-2 border rounded bg-gray-100" />
        <button type="button" onclick="detectarUbicacion()" class="mt-2 bg-blue-600 text-white px-4 py-1 rounded">📡 Detectar ubicación</button>
        <div id="mapa" class="h-64 mt-2 hidden rounded border"></div>
      </div>
      <div>
        <label class="block">📧 Correo (opcional):</label>
        <input type="email" id="correo" class="w-full p-2 border rounded" />
      </div>
      <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded">📤 Enviar Reclamo</button>
    </form>

    <hr class="my-8" />

    <h2 class="text-xl font-semibold mb-4">📄 Historial de mis Reclamos</h2>
    <div id="historial" class="space-y-4"></div>
  </div>

  <script>
    let coords = null;

    function cerrarSesion() {
      localStorage.removeItem("correo_usuario");
      window.location.href = "index.html";
    }

    function detectarUbicacion() {
      if (!navigator.geolocation) {
        alert("La geolocalización no es compatible");
        return;
      }

      navigator.geolocation.getCurrentPosition(async (pos) => {
        coords = { lat: pos.coords.latitude, lon: pos.coords.longitude };

        const res = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${coords.lat}&lon=${coords.lon}&format=json`);
        const data = await res.json();
        document.getElementById("ubicacion").value = data.display_name;

        document.getElementById("mapa").classList.remove("hidden");
        const map = L.map("mapa").setView([coords.lat, coords.lon], 16);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
        L.marker([coords.lat, coords.lon]).addTo(map).bindPopup("Tu ubicación detectada").openPopup();
      }, () => {
        alert("No se pudo detectar la ubicación.");
      });
    }

    document.getElementById("form-reclamo").addEventListener("submit", async function (e) {
      e.preventDefault();

      const tipo = document.getElementById("tipo").value;
      const descripcion = document.getElementById("descripcion").value;
      const ubicacion = document.getElementById("ubicacion").value;
      const correo = document.getElementById("correo").value;

      if (correo) localStorage.setItem("correo_usuario", correo);

      const res = await fetch("https://siresu1.onrender.com/reclamos", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ tipo, descripcion, ubicacion, correo })
      });

      if (res.ok) {
        alert("✅ Reclamo enviado");
        this.reset();
        document.getElementById("mapa").classList.add("hidden");
        cargarHistorial();
      } else {
        alert("❌ Error al enviar reclamo");
      }
    });

    async function cargarHistorial() {
      const correo = localStorage.getItem("correo_usuario");
      if (!correo) return;

      const res = await fetch("https://siresu1.onrender.com/api/reclamos");
      const datos = await res.json();
      const historial = datos.filter(r => r.correo === correo);

      const contenedor = document.getElementById("historial");
      contenedor.innerHTML = "";

      if (historial.length === 0) {
        contenedor.innerHTML = "<p class='text-gray-500'>No hay reclamos registrados.</p>";
        return;
      }

      historial.forEach(r => {
        const fecha = r.fecha ? new Date(r.fecha).toLocaleString() : "-";
        const finalizado = r.estado === "resuelto" && r.fecha_final ? new Date(r.fecha_final).toLocaleString() : "-";

        contenedor.innerHTML += `
          <div class="p-4 border rounded shadow bg-gray-50">
            <p><strong>Tipo:</strong> ${r.tipo}</p>
            <p><strong>Descripción:</strong> ${r.descripcion}</p>
            <p><strong>Ubicación:</strong> ${r.ubicacion}</p>
            <p><strong>Estado:</strong> ${r.estado}</p>
            <p><strong>Fecha de creación:</strong> ${fecha}</p>
            <p><strong>Fecha de finalización:</strong> ${finalizado}</p>
          </div>
        `;
      });
    }

    window.onload = () => {
      detectarUbicacion();
      cargarHistorial();
    };
  </script>
</body>
</html>
