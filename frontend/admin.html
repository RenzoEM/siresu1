<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel Admin - SIRESU</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6">

<h1 class="text-3xl font-bold mb-6 text-center">Panel de Administración</h1>

<!-- CREAR USUARIO -->
<div class="bg-white p-6 rounded shadow mb-8">
  <h2 class="text-xl font-bold mb-4">Crear Usuario</h2>

  <input id="newCorreo" type="email" placeholder="Correo"
    class="border p-2 w-full mb-2">

  <input id="newPassword" type="password" placeholder="Contraseña"
    class="border p-2 w-full mb-2">

  <select id="newRol" class="border p-2 w-full mb-2">
    <option value="cliente">Cliente</option>
    <option value="admin">Admin</option>
  </select>

  <button onclick="crearUsuario()"
    class="bg-blue-600 text-white px-4 py-2 rounded">
    Crear Usuario
  </button>
</div>

<!-- TABLA USUARIOS -->
<div class="bg-white p-6 rounded shadow mb-8">
  <h2 class="text-xl font-bold mb-4">Usuarios</h2>

  <table class="w-full border">
    <thead class="bg-gray-200">
      <tr>
        <th class="border p-2">Correo</th>
        <th class="border p-2">Contraseña</th>
        <th class="border p-2">Rol</th>
        <th class="border p-2">Acciones</th>
      </tr>
    </thead>
    <tbody id="tablaUsuarios"></tbody>
  </table>
</div>

<!-- TABLA RECLAMOS -->
<div class="bg-white p-6 rounded shadow">
  <h2 class="text-xl font-bold mb-4">Reclamos</h2>

  <table class="w-full border">
    <thead class="bg-gray-200">
      <tr>
        <th class="border p-2">Tipo</th>
        <th class="border p-2">Descripción</th>
        <th class="border p-2">Correo</th>
        <th class="border p-2">Estado</th>
      </tr>
    </thead>
    <tbody id="tablaReclamos"></tbody>
  </table>
</div>

<script>
const API = "https://siresu1.onrender.com";

// ================= USUARIOS =================

async function cargarUsuarios() {
  const res = await fetch(`${API}/usuarios`);
  const usuarios = await res.json();
  const tabla = document.getElementById("tablaUsuarios");
  tabla.innerHTML = "";

  usuarios.forEach(u => {
    tabla.innerHTML += `
      <tr>
        <td class="border p-2">${u.id}</td>

        <td class="border p-2">
          <input type="password" value="${u.password}"
            id="pass-${u.id}" disabled class="border p-1 w-full">
        </td>

        <td class="border p-2">
          <select id="rol-${u.id}" disabled class="border p-1 w-full">
            <option ${u.role === "cliente" ? "selected" : ""}>cliente</option>
            <option ${u.role === "admin" ? "selected" : ""}>admin</option>
          </select>
        </td>

        <td class="border p-2 space-x-2">
          <button onclick="habilitar('${u.id}')"
            class="bg-yellow-500 text-white px-2 py-1 rounded">
            Editar
          </button>

          <button onclick="actualizarUsuario('${u.id}')"
            class="bg-green-600 text-white px-2 py-1 rounded">
            Actualizar
          </button>
        </td>
      </tr>
    `;
  });
}

function habilitar(correo) {
  document.getElementById(`pass-${correo}`).disabled = false;
  document.getElementById(`rol-${correo}`).disabled = false;
}

async function actualizarUsuario(correo) {
  if (!confirm("¿Seguro que deseas actualizar este usuario?")) return;
  if (!confirm("CONFIRMACIÓN FINAL: ¿Actualizar datos?")) return;

  const password = document.getElementById(`pass-${correo}`).value;
  const rol = document.getElementById(`rol-${correo}`).value;

  const res = await fetch(`${API}/usuarios/${correo}`, {
    method: "PATCH",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      correo,
      password,
      rol
    })
  });

  const data = await res.json();
  alert(data.message || "Usuario actualizado");
  cargarUsuarios();
}

async function crearUsuario() {
  const correo = document.getElementById("newCorreo").value;
  const password = document.getElementById("newPassword").value;
  const rol = document.getElementById("newRol").value;

  const res = await fetch(`${API}/crear-usuario`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ correo, password, rol })
  });

  const data = await res.json();
  alert(data.message || data.error);
  cargarUsuarios();
}

// ================= RECLAMOS =================

async function cargarReclamos() {
  const res = await fetch(`${API}/api/reclamos`);
  const reclamos = await res.json();
  const tabla = document.getElementById("tablaReclamos");
  tabla.innerHTML = "";

  reclamos.forEach(r => {
    tabla.innerHTML += `
      <tr>
        <td class="border p-2">${r.tipo}</td>
        <td class="border p-2">${r.descripcion}</td>
        <td class="border p-2">${r.correo}</td>
        <td class="border p-2">${r.estado}</td>
      </tr>
    `;
  });
}

cargarUsuarios();
cargarReclamos();
</script>

</body>
</html>
