<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Panel Administrativo</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    .tab-content { transition: all .3s ease }
    .tab-hidden { display:none }
    .tab-visible { display:block }
  </style>
</head>

<body class="bg-gray-100 text-gray-800">

<div class="max-w-6xl mx-auto mt-10 p-6 bg-white rounded-xl shadow-md">

  <!-- HEADER -->
  <div class="flex justify-between items-center border-b pb-4 mb-6">
    <h1 class="text-2xl font-bold text-blue-700">üõ†Ô∏è Panel Administrativo</h1>
    <button onclick="cerrarSesion()" class="bg-red-600 text-white px-4 py-2 rounded">
      Cerrar sesi√≥n
    </button>
  </div>

  <!-- TABS -->
  <div class="flex space-x-4 border-b mb-6 text-sm font-medium">
    <button class="tab-link border-b-2 border-blue-600 px-4 py-2"
      onclick="cambiarTab(event,'crear')">‚ûï Agregar Usuario</button>

    <button class="tab-link px-4 py-2"
      onclick="cambiarTab(event,'usuarios')">üë• Lista de Usuarios</button>

    <button class="tab-link px-4 py-2"
      onclick="cambiarTab(event,'reclamos')">üìã Lista de Reclamos</button>
  </div>

  <!-- CREAR USUARIO -->
  <div id="crear" class="tab-content tab-visible">
    <h2 class="text-xl font-semibold mb-4">Agregar Nuevo Usuario</h2>

    <form id="formCrear" class="grid md:grid-cols-3 gap-4">
      <input id="nuevoCorreo" type="email" placeholder="Correo" required class="border p-2 rounded">
      <input id="nuevoPass" type="password" placeholder="Contrase√±a" required class="border p-2 rounded">
      <select id="nuevoRol" class="border p-2 rounded">
        <option value="cliente">Cliente</option>
        <option value="admin">Admin</option>
      </select>
      <button class="bg-blue-600 text-white rounded p-2 col-span-full">
        Crear Usuario
      </button>
    </form>
  </div>

  <!-- LISTA USUARIOS -->
  <div id="usuarios" class="tab-content tab-hidden">
    <h2 class="text-xl font-semibold mb-4">Lista de Usuarios</h2>

    <table class="w-full border">
      <thead class="bg-gray-200">
        <tr>
          <th class="border p-2">Correo</th>
          <th class="border p-2">Contrase√±a</th>
          <th class="border p-2">Rol</th>
          <th class="border p-2">Acciones</th>
        </tr>
      </thead>
      <tbody id="tablaUsuarios"></tbody>
    </table>
  </div>

  <!-- LISTA RECLAMOS -->
  <div id="reclamos" class="tab-content tab-hidden">
    <h2 class="text-xl font-semibold mb-4">Lista de Reclamos</h2>

    <div class="flex gap-4 mb-4">
  <select id="filtroEstado"
    class="border p-2 rounded"
    onchange="cargarReclamos()">
    <option value="">Todos</option>
    <option value="pendiente">Pendiente</option>
    <option value="en proceso">En proceso</option>
    <option value="resuelto">Resuelto</option>
  </select>

  <select id="filtroOrden"
    class="border p-2 rounded"
    onchange="cargarReclamos()">
    <option value="reciente" selected>M√°s recientes</option>
    <option value="antiguo">M√°s antiguos</option>
  </select>
</div>


    <table class="w-full border">
      <thead class="bg-gray-200">
  <tr>
    <th class="border p-2">Tipo</th>
    <th class="border p-2">Descripci√≥n</th>
    <th class="border p-2">Direcci√≥n</th>
    <th class="border p-2">Correo</th>
    <th class="border p-2">Estado</th>
    <th class="border p-2">Fecha</th>
  </tr>
</thead>

      <tbody id="tablaReclamos"></tbody>
    </table>
  </div>

</div>

<script>
const API = "https://siresu1.onrender.com";

/* ===== SESI√ìN ===== */
function cerrarSesion(){
  localStorage.clear();
  location.href = "index.html";
}

/* ===== TABS ===== */
function cambiarTab(e,tab){
  document.querySelectorAll(".tab-content").forEach(t=>{
    t.classList.add("tab-hidden");
    t.classList.remove("tab-visible");
  });
  document.getElementById(tab).classList.remove("tab-hidden");
  document.getElementById(tab).classList.add("tab-visible");

  document.querySelectorAll(".tab-link").forEach(b=>b.classList.remove("border-blue-600"));
  e.target.classList.add("border-blue-600");
}

/* ===== CREAR USUARIO ===== */
formCrear.onsubmit = async e => {
  e.preventDefault();

  const res = await fetch(`${API}/crear-usuario`,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({
      correo:nuevoCorreo.value.trim(),
      password:nuevoPass.value,
      rol:nuevoRol.value
    })
  });

  if(res.ok){
    alert("‚úÖ Usuario creado");
    formCrear.reset();
    cargarUsuarios();
    document.querySelectorAll(".tab-link")[1].click();
  } else {
    alert("‚ùå Error al crear usuario");
  }
};

/* ===== USUARIOS ===== */
async function cargarUsuarios(){
  const res = await fetch(`${API}/usuarios`);
  const data = await res.json();
  tablaUsuarios.innerHTML="";

  data.forEach(u=>{
    tablaUsuarios.innerHTML+=`
    <tr>
      <td class="border p-2">${u.id}</td>

      <td class="border p-2">
        <div class="flex gap-2">
          <input type="password" id="p-${u.id}" value="${u.password}" disabled class="border p-1 rounded w-full">
          <button onclick="verPass('${u.id}')">üëÅÔ∏è</button>
        </div>
      </td>

      <td class="border p-2">
        <select id="r-${u.id}" disabled class="border p-1 rounded">
          <option value="cliente" ${u.role=="cliente"?"selected":""}>cliente</option>
          <option value="admin" ${u.role=="admin"?"selected":""}>admin</option>
        </select>
      </td>

      <td class="border p-2 space-x-1">
        <button onclick="editar('${u.id}')" class="bg-yellow-500 text-white px-2 rounded">Actualizar</button>
        <button onclick="guardar('${u.id}')" class="bg-blue-600 text-white px-2 rounded">Guardar</button>
        <button onclick="eliminar('${u.id}')" class="bg-red-600 text-white px-2 rounded">Eliminar</button>
      </td>
    </tr>`;
  });
}

function editar(id){
  document.getElementById(`p-${id}`).disabled=false;
  document.getElementById(`r-${id}`).disabled=false;
}

async function guardar(id){
  if(!confirm("¬øSeguro de guardar cambios?")) return;
  if(!confirm("Confirmar nuevamente la actualizaci√≥n")) return;

  await fetch(`${API}/usuarios/${id}`,{
    method:'PATCH',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({
      password:document.getElementById(`p-${id}`).value,
      rol:document.getElementById(`r-${id}`).value
    })
  });

  alert("‚úÖ Usuario actualizado");
  cargarUsuarios();
}

async function eliminar(id){
  if(confirm("¬øEliminar usuario y todos sus reclamos?")){
    await fetch(`${API}/usuarios/${id}`,{method:'DELETE'});
    cargarUsuarios();
  }
}

function verPass(id){
  const i=document.getElementById(`p-${id}`);
  i.type=i.type==="password"?"text":"password";
}

/* ===== RECLAMOS ===== */
async function cargarReclamos(){
  const res = await fetch(`${API}/api/reclamos`);
  const data = await res.json();

  const filtro = filtroEstado.value;
  const orden = filtroOrden.value;

  // üîπ Filtrar por estado
  let lista = data.filter(r => !filtro || r.estado === filtro);

  // üîπ Ordenar por fecha
  lista.sort((a, b) => {
    const fa = new Date(a.fecha);
    const fb = new Date(b.fecha);
    return orden === "reciente" ? fb - fa : fa - fb;
  });

  tablaReclamos.innerHTML = "";

  lista.forEach(r => {
    const estado = (r.estado || "").toLowerCase();

const color =
  estado === "pendiente" ? "bg-yellow-100" :
  estado === "en proceso" ? "bg-blue-100" :
  estado === "resuelto" ? "bg-green-100" :
  "bg-gray-100";


    // üïí Fecha en horario de Per√∫
    function fechaPeruCorrecta(fechaISO) {
  const fechaUTC = new Date(fechaISO);

  // Restar 5 horas (UTC-5 Per√∫)
  fechaUTC.setHours(fechaUTC.getHours() - 5);

  return fechaUTC.toLocaleString("es-PE", {
    day: "2-digit",
    month: "2-digit",
    year: "2-digit",
    hour: "2-digit",
    minute: "2-digit",
    hour12: true
  });
}


    tablaReclamos.innerHTML += `
      <tr class="${color}">
        <td class="border p-2">${r.tipo}</td>
        <td class="border p-2">${r.descripcion}</td>
        <td class="border p-2">${r.ubicacion || "-"}</td>
        <td class="border p-2">${r.correo}</td>
        <td class="border p-2">
          <select onchange="cambiarEstado('${r.id}',this.value)"
            class="border p-1 rounded">
            <option ${r.estado=="pendiente"?"selected":""}>pendiente</option>
            <option ${r.estado=="en proceso"?"selected":""}>en proceso</option>
            <option ${r.estado=="resuelto"?"selected":""}>resuelto</option>
          </select>
        </td>
        <td class="border p-2">${fechaPeruCorrecta(r.fecha)}</td>

      </tr>
    `;
  });
}
async function cambiarEstado(id,estado){
  await fetch(`${API}/api/reclamos/${id}`,{
    method:'PATCH',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({estado})
  });
  cargarReclamos();
}

window.onload=()=>{
  cargarUsuarios();
  cargarReclamos();
}
</script>

</body>
</html>
