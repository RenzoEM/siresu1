<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Panel Administrativo</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 text-gray-800">
  <div class="max-w-7xl mx-auto mt-10 p-6 bg-white rounded-xl shadow-md">

    <!-- HEADER -->
    <div class="flex justify-between items-center border-b pb-4 mb-6">
      <h1 class="text-2xl font-bold text-blue-700">üõ†Ô∏è Panel Administrativo</h1>
      <button onclick="cerrarSesion()" class="bg-red-600 text-white px-4 py-2 rounded">
        Cerrar sesi√≥n
      </button>
    </div>

    <!-- TABS -->
    <div class="flex space-x-4 border-b mb-6">
      <button onclick="mostrarTab('usuarios')" class="tab-btn border-b-2 border-blue-600 px-4 py-2">
        üë• Usuarios
      </button>
      <button onclick="mostrarTab('reclamos')" class="tab-btn px-4 py-2">
        üìã Reclamos
      </button>
    </div>

    <!-- TAB USUARIOS -->
    <div id="tab-usuarios">
      <h2 class="text-xl font-semibold mb-4">Lista de Usuarios</h2>

      <div class="overflow-x-auto">
        <table class="min-w-full border border-gray-300 rounded">
          <thead class="bg-blue-600 text-white">
            <tr>
              <th class="p-2">Correo</th>
              <th class="p-2">Contrase√±a</th>
              <th class="p-2">Rol</th>
              <th class="p-2">Acciones</th>
            </tr>
          </thead>
          <tbody id="usuarios-tabla"></tbody>
        </table>
      </div>
    </div>

    <!-- TAB RECLAMOS -->
    <div id="tab-reclamos" class="hidden">
      <h2 class="text-xl font-semibold mb-4">Lista de Reclamos</h2>

      <div class="overflow-x-auto">
        <table class="min-w-full border border-gray-300 rounded">
          <thead class="bg-green-600 text-white">
            <tr>
              <th class="p-2">Tipo</th>
              <th class="p-2">Descripci√≥n</th>
              <th class="p-2">Ubicaci√≥n</th>
              <th class="p-2">Correo</th>
              <th class="p-2">Fecha</th>
              <th class="p-2">Estado</th>
            </tr>
          </thead>
          <tbody id="reclamos-tabla"></tbody>
        </table>
      </div>
    </div>

  </div>

  <!-- SCRIPT -->
  <script>
    const API = "https://siresu1.onrender.com";

    function cerrarSesion() {
      localStorage.removeItem("correo_usuario");
      window.location.href = "index.html";
    }

    function mostrarTab(tab) {
      document.getElementById("tab-usuarios").classList.add("hidden");
      document.getElementById("tab-reclamos").classList.add("hidden");

      document.getElementById(`tab-${tab}`).classList.remove("hidden");

      document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("border-blue-600"));
      event.target.classList.add("border-blue-600");
    }

    // ================= USUARIOS =================
    async function cargarUsuarios() {
      const res = await fetch(`${API}/usuarios`);
      const usuarios = await res.json();
      const tbody = document.getElementById("usuarios-tabla");
      tbody.innerHTML = "";

      usuarios.forEach(u => {
        const tr = document.createElement("tr");
        tr.className = "border-b";

        tr.innerHTML = `
          <td class="p-2">
            <input value="${u.id}" disabled class="border p-1 rounded w-full">
          </td>
          <td class="p-2">
            <input id="pass-${u.id}" value="${u.password}" class="border p-1 rounded w-full">
          </td>
          <td class="p-2">
            <select id="rol-${u.id}" class="border p-1 rounded">
              <option value="cliente" ${u.role === "cliente" ? "selected" : ""}>Cliente</option>
              <option value="admin" ${u.role === "admin" ? "selected" : ""}>Admin</option>
            </select>
          </td>
          <td class="p-2 space-x-2">
            <button onclick="guardarUsuario('${u.id}')" class="bg-blue-600 text-white px-3 py-1 rounded">
              üíæ Guardar
            </button>
            <button onclick="eliminarUsuario('${u.id}')" class="bg-red-600 text-white px-3 py-1 rounded">
              üóëÔ∏è
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function guardarUsuario(correo) {
      const password = document.getElementById(`pass-${correo}`).value;
      const rol = document.getElementById(`rol-${correo}`).value;

      const res = await fetch(`${API}/usuarios/${correo}`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ correo, password, rol })
      });

      if (res.ok) {
        alert("‚úÖ Usuario actualizado");
        cargarUsuarios();
      } else {
        alert("‚ùå Error al actualizar");
      }
    }

    async function eliminarUsuario(correo) {
      if (!confirm("¬øEliminar usuario y sus reclamos?")) return;

      const res = await fetch(`${API}/usuarios/${correo}`, { method: "DELETE" });

      if (res.ok) {
        alert("Usuario eliminado");
        cargarUsuarios();
      }
    }

    // ================= RECLAMOS =================
    async function cargarReclamos() {
      const res = await fetch(`${API}/api/reclamos`);
      const reclamos = await res.json();
      const tbody = document.getElementById("reclamos-tabla");
      tbody.innerHTML = "";

      reclamos.forEach(r => {
        const tr = document.createElement("tr");
        tr.className = "border-b";

        tr.innerHTML = `
          <td class="p-2">${r.tipo}</td>
          <td class="p-2">${r.descripcion}</td>
          <td class="p-2">${r.ubicacion}</td>
          <td class="p-2">${r.correo}</td>
          <td class="p-2">${new Date(r.fecha).toLocaleString()}</td>
          <td class="p-2">
            <select onchange="actualizarEstado('${r.id}', this.value)"
              class="border p-1 rounded">
              <option value="pendiente" ${r.estado === "pendiente" ? "selected" : ""}>Pendiente</option>
              <option value="en proceso" ${r.estado === "en proceso" ? "selected" : ""}>En proceso</option>
              <option value="resuelto" ${r.estado === "resuelto" ? "selected" : ""}>Resuelto</option>
            </select>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function actualizarEstado(id, estado) {
      await fetch(`${API}/api/reclamos/${id}`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ estado })
      });
      alert("Estado actualizado");
    }

    window.onload = () => {
      cargarUsuarios();
      cargarReclamos();
    };
  </script>
</body>
</html>
